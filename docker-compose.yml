version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8001:8001"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    dns:
      - 1.1.1.1
      - 8.8.8.8
    environment:
      # Pass through all environment variables from .env
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${PORT:-8001}
      - PORT_AUTO=${PORT_AUTO:-false}

      # Data policy
      - VITE_APP_MODE=${VITE_APP_MODE:-online}
      - VITE_STRICT_REAL_DATA=${VITE_STRICT_REAL_DATA:-true}
      - VITE_USE_MOCK_DATA=${VITE_USE_MOCK_DATA:-false}
      - VITE_ALLOW_FAKE_DATA=${VITE_ALLOW_FAKE_DATA:-false}
      - USE_MOCK_DATA=${USE_MOCK_DATA:-false}
      - OFFLINE_ALLOW=${OFFLINE_ALLOW:-false}

      # API endpoints
      - VITE_API_BASE=${VITE_API_BASE:-http://localhost:8001/api}
      - VITE_WS_BASE=${VITE_WS_BASE:-ws://localhost:8001}

      # Feature flags
      - FEATURE_FUTURES=${FEATURE_FUTURES:-false}
      - FEATURE_AI_ENHANCED=${FEATURE_AI_ENHANCED:-true}
      - EXCHANGE_KUCOIN=${EXCHANGE_KUCOIN:-true}

      # Networking (Docker egress)
      - DEFAULT_UA=${DEFAULT_UA:-DreammakerCrypto/1.0}
      - HTTP_PROXY=${HTTP_PROXY}
      - HTTPS_PROXY=${HTTPS_PROXY}
      - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1,::1,host.docker.internal,api.binance.com,api.kraken.com,api-pub.bitfinex.com,api.alternative.me,newsapi.org,pro-api.coinmarketcap.com,min-api.cryptocompare.com,api.santiment.net,api.whale-alert.io}

      # API keys
      - CMC_API_KEY=${CMC_API_KEY}
      - CMC_API_KEY_2=${CMC_API_KEY_2}
      - CRYPTOCOMPARE_KEY=${CRYPTOCOMPARE_KEY}
      - NEWS_API_KEY=${NEWS_API_KEY}
      - NEWSAPI_KEY=${NEWSAPI_KEY}
      - CRYPTOPANIC_KEY=${CRYPTOPANIC_KEY}
      - CRYPOPANIC_KEY=${CRYPOPANIC_KEY}
      - WHALEALERT_KEY=${WHALEALERT_KEY}
      - WHALE_ALERT_KEY=${WHALE_ALERT_KEY}
      - SANTIMENT_KEY=${SANTIMENT_KEY}
      - ETHERSCAN_API_KEY=${ETHERSCAN_API_KEY}
      - ETHERSCAN_API_KEY_2=${ETHERSCAN_API_KEY_2}
      - BSCSCAN_API_KEY=${BSCSCAN_API_KEY}
      - TRONSCAN_API_KEY=${TRONSCAN_API_KEY}
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY}
      - HF_TOKEN_B64=${HF_TOKEN_B64}

      # Redis
      - DISABLE_REDIS=${DISABLE_REDIS:-false}
      - REDIS_HOST=${REDIS_HOST:-localhost}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD}

      # Performance
      - PROVIDER_TTL_MS=${PROVIDER_TTL_MS:-60000}
      - PRICE_CACHE_TTL_MS=${PRICE_CACHE_TTL_MS:-5000}

      # Futures trading
      - KUCOIN_FUTURES_KEY=${KUCOIN_FUTURES_KEY}
      - KUCOIN_FUTURES_SECRET=${KUCOIN_FUTURES_SECRET}
      - KUCOIN_FUTURES_PASSPHRASE=${KUCOIN_FUTURES_PASSPHRASE}
      - FUTURES_BASE_URL=${FUTURES_BASE_URL:-https://api-futures.kucoin.com}

      # Binance
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_SECRET_KEY=${BINANCE_SECRET_KEY}

      # Telegram
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}

    volumes:
      - ./data:/app/data
      - ./config:/app/config
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: Frontend service (Vite dev server)
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    ports:
      - "5173:5173"
    environment:
      - VITE_API_BASE=${VITE_API_BASE:-http://localhost:8001/api}
      - VITE_WS_BASE=${VITE_WS_BASE:-ws://localhost:8001}
      - VITE_APP_MODE=${VITE_APP_MODE:-online}
      - VITE_STRICT_REAL_DATA=${VITE_STRICT_REAL_DATA:-true}
      - VITE_USE_MOCK_DATA=${VITE_USE_MOCK_DATA:-false}
      - VITE_ALLOW_FAKE_DATA=${VITE_ALLOW_FAKE_DATA:-false}
    command: npm run dev:client
    volumes:
      - ./src:/app/src
      - ./public:/app/public
      - ./index.html:/app/index.html
    depends_on:
      - backend
    profiles:
      - dev
